// üöÄ COOKIE √ñM√úR TAKƒ∞P Sƒ∞STEMƒ∞
const express = require('express');
const { chromium } = require('playwright');
const app = express();

// COOKIE TAKƒ∞P VERƒ∞LERƒ∞
let cookieHistory = [];
let currentCookies = [];
let cookieLifespanStats = {
    total_tests: 0,
    changed_cookies: 0,
    average_lifespan: 0,
    min_lifespan: 0,
    max_lifespan: 0
};

// COOKIE KAR≈ûILA≈ûTIRMA FONKSƒ∞YONU
function compareCookies(oldCookies, newCookies) {
    const changes = {
        added: [],
        removed: [],
        changed: [],
        unchanged: []
    };

    const oldMap = new Map(oldCookies.map(c => [c.name, c]));
    const newMap = new Map(newCookies.map(c => [c.name, c]));

    // Yeni eklenen cookie'ler
    for (const [name, cookie] of newMap) {
        if (!oldMap.has(name)) {
            changes.added.push(cookie);
        }
    }

    // Silinen cookie'ler
    for (const [name, cookie] of oldMap) {
        if (!newMap.has(name)) {
            changes.removed.push(cookie);
        }
    }

    // Deƒüi≈üen cookie'ler
    for (const [name, newCookie] of newMap) {
        if (oldMap.has(name)) {
            const oldCookie = oldMap.get(name);
            if (oldCookie.value !== newCookie.value) {
                changes.changed.push({
                    name: name,
                    old_value: oldCookie.value,
                    new_value: newCookie.value,
                    old_cookie: oldCookie,
                    new_cookie: newCookie
                });
            } else {
                changes.unchanged.push(newCookie);
            }
        }
    }

    return changes;
}

// COOKIE √ñM√úR HESAPLAMA
function calculateCookieLifespan(history) {
    if (history.length < 2) return null;

    const changes = [];
    
    for (let i = 1; i < history.length; i++) {
        const current = history[i];
        const previous = history[i - 1];
        
        const comparison = compareCookies(previous.cookies, current.cookies);
        
        if (comparison.changed.length > 0 || comparison.added.length > 0 || comparison.removed.length > 0) {
            const lifespanMs = new Date(current.timestamp) - new Date(previous.timestamp);
            const lifespanMinutes = Math.round(lifespanMs / (1000 * 60));
            
            changes.push({
                timestamp: current.timestamp,
                previous_timestamp: previous.timestamp,
                lifespan_minutes: lifespanMinutes,
                changes: comparison
            });
        }
    }

    return changes;
}

// COOKIE TOPLAMA FONKSƒ∞YONU
async function collectCookies() {
    let browser;
    let context;
    let page;
    
    try {
        console.log('üç™ COOKIE TOPLANIYOR...');
        
        // Browser'ƒ± ba≈ülat
        browser = await chromium.launch({
            headless: true,
            args: [
                '--no-sandbox',
                '--disable-setuid-sandbox',
                '--disable-dev-shm-usage',
                '--disable-accelerated-2d-canvas',
                '--no-first-run',
                '--disable-gpu',
                '--disable-web-security'
            ]
        });

        // Context ve sayfa olu≈ütur
        context = await browser.newContext({
            viewport: { width: 1920, height: 1080 },
            userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
        });

        page = await context.newPage();

        // Hepsiburada'ya git
        console.log('üåê Hepsiburada\'ya gidiliyor...');
        await page.goto('https://www.hepsiburada.com/siparislerim', {
            waitUntil: 'networkidle',
            timeout: 30000
        });

        // Cookie'lerin olu≈ümasƒ±nƒ± bekle
        console.log('‚è≥ Cookie\'ler bekleniyor...');
        await page.waitForTimeout(5000);

        // JavaScript ile cookie'leri oku
        const jsCookies = await page.evaluate(() => {
            return document.cookie;
        });

        console.log('üìä JavaScript Cookie:', jsCookies);

        // Context cookie'lerini al
        const contextCookies = await context.cookies();
        
        // Cookie verilerini hazƒ±rla
        const cookieData = {
            timestamp: new Date().toISOString(),
            timestamp_readable: new Date().toLocaleString('tr-TR'),
            total_cookies: contextCookies.length,
            hbus_cookies: contextCookies.filter(c => c.name.includes('hbus_')).length,
            cookies: contextCookies.map(cookie => ({
                name: cookie.name,
                value: cookie.value.substring(0, 50) + (cookie.value.length > 50 ? '...' : ''),
                full_value_length: cookie.value.length,
                domain: cookie.domain,
                path: cookie.path,
                expires: cookie.expires ? new Date(cookie.expires * 1000).toISOString() : 'Session',
                httpOnly: cookie.httpOnly || false,
                secure: cookie.secure || false,
                sameSite: cookie.sameSite || 'Lax'
            })),
            js_cookies: jsCookies
        };

        // Ge√ßmi≈üe ekle
        cookieHistory.push(cookieData);
        
        // Sadece son 50 kayƒ±t tut
        if (cookieHistory.length > 50) {
            cookieHistory = cookieHistory.slice(-50);
        }

        // Mevcut cookie'leri g√ºncelle
        currentCookies = contextCookies;

        console.log(`‚úÖ ${contextCookies.length} cookie toplandƒ±`);
        
        return cookieData;

    } catch (error) {
        console.log('‚ùå COOKIE TOPLAMA HATASI:', error.message);
        return {
            timestamp: new Date().toISOString(),
            error: error.message,
            cookies: []
        };
    } finally {
        // Temizlik
        if (page) await page.close();
        if (context) await context.close();
        if (browser) await browser.close();
    }
}

// COOKIE DEƒûƒ∞≈ûƒ∞M ANALƒ∞Zƒ∞
function analyzeCookieChanges() {
    if (cookieHistory.length < 2) {
        return { message: 'Yeterli veri yok, en az 2 √∂l√ß√ºm gerekli' };
    }

    const changes = calculateCookieLifespan(cookieHistory);
    const allLifespans = changes.map(c => c.lifespan_minutes);
    
    if (allLifespans.length > 0) {
        cookieLifespanStats = {
            total_tests: changes.length,
            changed_cookies: changes.reduce((sum, change) => sum + change.changes.changed.length, 0),
            average_lifespan: Math.round(allLifespans.reduce((a, b) => a + b, 0) / allLifespans.length),
            min_lifespan: Math.min(...allLifespans),
            max_lifespan: Math.max(...allLifespans),
            last_change: changes[changes.length - 1]
        };
    }

    return {
        stats: cookieLifespanStats,
        recent_changes: changes.slice(-5), // Son 5 deƒüi≈üim
        total_measurements: cookieHistory.length
    };
}

// EXPRESS ROUTES

// ANA SAYFA
app.get('/', (req, res) => {
    res.json({
        service: 'üç™ Cookie √ñm√ºr Takip Sistemi',
        description: 'Cookie\'lerin ne zaman deƒüi≈ütiƒüini takip eder',
        endpoints: {
            '/': 'Bu sayfa',
            '/collect': 'Cookie topla',
            '/history': 'Cookie ge√ßmi≈üi',
            '/analysis': 'Cookie deƒüi≈üim analizi',
            '/current': 'Mevcut cookie\'ler',
            '/stats': 'ƒ∞statistikler'
        },
        current_status: {
            total_measurements: cookieHistory.length,
            last_collection: cookieHistory.length > 0 ? cookieHistory[cookieHistory.length - 1].timestamp_readable : 'Hen√ºz yok',
            active_tracking: '5 dakikada bir otomatik'
        }
    });
});

// COOKIE TOPLA
app.get('/collect', async (req, res) => {
    console.log('\n=== MANUEL COOKIE TOPLAMA ===');
    const result = await collectCookies();
    
    // Analiz yap
    const analysis = analyzeCookieChanges();
    
    res.json({
        collection: result,
        analysis: analysis
    });
});

// COOKIE GE√áMƒ∞≈ûƒ∞
app.get('/history', (req, res) => {
    res.json({
        total_measurements: cookieHistory.length,
        history: cookieHistory.map(entry => ({
            timestamp: entry.timestamp_readable,
            total_cookies: entry.total_cookies,
            hbus_cookies: entry.hbus_cookies,
            cookie_names: entry.cookies.map(c => c.name)
        }))
    });
});

// COOKIE ANALƒ∞Zƒ∞
app.get('/analysis', (req, res) => {
    const analysis = analyzeCookieChanges();
    
    res.json({
        analysis: analysis,
        recommendations: getCookieRecommendations(analysis)
    });
});

// MEVCUT COOKIE'LER
app.get('/current', (req, res) => {
    if (cookieHistory.length === 0) {
        return res.json({ message: 'Hen√ºz cookie toplanmadƒ±' });
    }
    
    const current = cookieHistory[cookieHistory.length - 1];
    res.json({
        last_update: current.timestamp_readable,
        cookies: current.cookies
    });
});

// ƒ∞STATƒ∞STƒ∞KLER
app.get('/stats', (req, res) => {
    const analysis = analyzeCookieChanges();
    
    res.json({
        lifespan_stats: cookieLifespanStats,
        current_state: {
            total_measurements: cookieHistory.length,
            current_cookies: currentCookies.length,
            tracking_duration: cookieHistory.length > 1 ? 
                Math.round((new Date() - new Date(cookieHistory[0].timestamp)) / (1000 * 60)) + ' dakika' : 'Yeni ba≈üladƒ±'
        },
        predictions: {
            next_expected_change: cookieLifespanStats.average_lifespan > 0 ? 
                `~${cookieLifespanStats.average_lifespan} dakika sonra` : 'Bilinmiyor',
            stability: cookieLifespanStats.average_lifespan > 30 ? 'Y√ºksek' : 
                      cookieLifespanStats.average_lifespan > 10 ? 'Orta' : 'D√º≈ü√ºk'
        }
    });
});

// TAVSƒ∞YELER
function getCookieRecommendations(analysis) {
    if (!analysis.stats || analysis.stats.total_tests === 0) {
        return ['Daha fazla veri toplanmasƒ± gerekiyor'];
    }

    const stats = analysis.stats;
    const recommendations = [];

    if (stats.average_lifespan < 10) {
        recommendations.push('‚ùå Cookie √∂mr√º √ßok kƒ±sa (<10 dk) - Sƒ±k yenileme gerekebilir');
    } else if (stats.average_lifespan < 30) {
        recommendations.push('‚ö†Ô∏è Cookie √∂mr√º orta seviye (10-30 dk) - Orta sƒ±klƒ±kta yenileme');
    } else {
        recommendations.push('‚úÖ Cookie √∂mr√º uzun (>30 dk) - Nadiren yenileme gerekir');
    }

    if (stats.changed_cookies > 0) {
        recommendations.push(`üîç ${stats.changed_cookies} cookie deƒüi≈üimi tespit edildi`);
    }

    recommendations.push(`üéØ √ñnerilen yenileme sƒ±klƒ±ƒüƒ±: ${Math.max(5, Math.floor(stats.average_lifespan / 2))} dakika`);

    return recommendations;
}

// 5 DAKƒ∞KADA Bƒ∞R OTOMATƒ∞K COOKIE TOPLAMA
setInterval(async () => {
    console.log('\nüïí === 5 DAKƒ∞KALIK OTOMATƒ∞K COOKIE KONTROL√ú ===');
    console.log('‚è∞', new Date().toLocaleString('tr-TR'));
    
    const result = await collectCookies();
    const analysis = analyzeCookieChanges();
    
    if (analysis.stats && analysis.stats.total_tests > 0) {
        const lastChange = analysis.stats.last_change;
        if (lastChange) {
            console.log(`üìà Son deƒüi≈üim: ${lastChange.lifespan_minutes} dakika √∂nce`);
            console.log(`üîÅ Deƒüi≈üen cookie: ${lastChange.changes.changed.length} adet`);
        }
        
        console.log(`üìä Ortalama √∂m√ºr: ${analysis.stats.average_lifespan} dakika`);
    }
    
    console.log('====================================\n');
}, 5 * 60 * 1000); // 5 dakika

// SUNUCU BA≈ûLATMA
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
    console.log('\nüöÄ ===================================');
    console.log('üöÄ COOKIE √ñM√úR TAKƒ∞P Sƒ∞STEMƒ∞ √áALI≈ûIYOR!');
    console.log('üöÄ ===================================');
    console.log(`üìç Port: ${PORT}`);
    console.log('üìç / - Endpoint listesi');
    console.log('üìç /collect - Cookie topla');
    console.log('üìç /history - Cookie ge√ßmi≈üi');
    console.log('üìç /analysis - Cookie deƒüi≈üim analizi');
    console.log('üìç /current - Mevcut cookie\'ler');
    console.log('üìç /stats - ƒ∞statistikler');
    console.log('‚è∞ 5 dakikada bir otomatik cookie toplama');
    console.log('üéØ Cookie deƒüi≈üim s√ºrelerini analiz eder');
    console.log('üìà Ortalama cookie √∂mr√ºn√º hesaplar');
    console.log('====================================\n');
    
    // ƒ∞lk √ßalƒ±≈ütƒ±rma
    setTimeout(() => {
        console.log('üîÑ ƒ∞lk cookie toplama ba≈ülatƒ±lƒ±yor...');
        collectCookies();
    }, 3000);
});
